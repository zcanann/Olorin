Squalr Testing Framework Audit
Date: 2026-02-08
Audited by: Codex (GPT-5)

Scope
- Reviewed workspace test crate layout and mocks under `squalr-tests`.
- Reviewed privileged OS DI seam wiring in `squalr-engine`.
- Ran `cargo test -p squalr-tests` (result: pass, 107 integration tests).

Summary
- Current framework is strong for command/response contract testing (dispatch + typed callback decode) and has a good initial deterministic OS-behavior layer.
- Main risk is not correctness of existing tests; it is missing enforcement and missing negative/failure-path depth.

Findings (highest risk first)

1) High: No visible CI workflow enforcing this suite.
Evidence
- No `.github/workflows` directory was found in the repository root during audit.
Risk
- Regressions can land silently if contributors do not run `cargo test -p squalr-tests` locally.
Recommendation
- Add CI that runs at least:
  - `cargo test -p squalr-tests`
  - optional follow-up: `cargo test --workspace` on a scheduled/nightly lane.

2) Medium: OS DI seam tests are mostly success-path; failure semantics are under-tested.
Evidence
- Mock supports explicit failures (`set_write_success`, `set_read_success`) in `squalr-tests/src/mocks/mock_os.rs:94` and `squalr-tests/src/mocks/mock_os.rs:103`.
- No tests currently exercise those toggles (no references under `squalr-tests/tests`).
- Deterministic OS suite currently focuses on successful provider routing in `squalr-tests/tests/os_behavior_command_tests.rs`.
Risk
- Executor behavior on read/write/open failure can regress without detection (error responses, partial updates, freeze toggles on failed reads, etc.).
Recommendation
- Add targeted negative-path tests for:
  - `memory_read`/`memory_write` failures.
  - `process_open` failure (missing mocked opened process).
  - scan-results read failure paths for `list/query/refresh/freeze/set_property`.

3) Medium: `scan_results add_to_project` remains behaviorally untested because executor is still a stub.
Evidence
- Stubbed executor returns default response in `squalr-engine/src/command_executors/scan_results/add_to_project/scan_results_add_to_project_request_executor.rs:13`.
- Current tests cover command contract parsing/dispatch only in `squalr-tests/tests/scan_results_command_tests.rs`.
Risk
- Once project mutation hooks are implemented, there is no pre-existing deterministic behavior harness for this path.
Recommendation
- Keep current contract tests, then add OS/project-behavior tests immediately when project mutation hooks are wired.

4) Medium: Parser tests are almost entirely positive-path acceptance tests.
Evidence
- Parser test naming is predominantly `*_accepts_*` across command suites in `squalr-tests/tests/*_command_tests.rs`.
- No explicit invalid-input parser assertions (missing required flags, malformed values, bad enum strings) were identified.
Risk
- CLI contract may accept/interpret invalid user input incorrectly without test coverage.
Recommendation
- Add compact parser rejection suites per command family for malformed or incomplete args.

5) Low: Test signal can be diluted by unrelated compiler warnings in dependent crates.
Evidence
- `cargo test -p squalr-tests` passes, but emits many warnings from `squalr-engine-api`, `squalr-engine-scanning`, and `squalr-engine`.
Risk
- Important new warnings tied to tested paths can be missed.
Recommendation
- Reduce baseline warnings over time and consider warning budgets in CI for touched crates.

Strengths observed
- Good command contract breadth across privileged and unprivileged flows in `squalr-tests/tests/*_command_tests.rs`.
- DI seam is clean and minimal (`EngineOsProviders`) in `squalr-engine/src/os/engine_os_provider.rs` and injected via `EnginePrivilegedState::new_with_os_providers` in `squalr-engine/src/engine_privileged_state.rs:45`.
- Deterministic OS-behavior tests validate real routing through injected providers in `squalr-tests/tests/os_behavior_command_tests.rs`.

Overall score
- Coverage breadth: 8/10.
- Determinism/isolation: 8/10.
- Failure-path depth: 5/10.
- Automation/enforcement: 3/10.
- Net: 6.5/10 (solid foundation; biggest gains are CI + negative-path depth).